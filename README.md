# ST3215-3-DualButton

M5StampS3を使用してSTS3215サーボモーター3台を6つのボタンで制御するプロジェクト。各軸にリミットスイッチ（EXTIO2経由）を備え、端点で自動停止します。

## 概要

各サーボモーターに対して正回転・逆回転用の2つのボタンを割り当て、計6つのボタンで3台のSTS3215を制御します。EXTIO2モジュール経由でリミットスイッチを読み取り、各軸の動作範囲を制限します。

## ハードウェア構成

### マイコン
- **M5StampS3** (ESP32-S3)

### サーボモーター
- **Feetech STS3215** x 3台
  - ID 1, 2, 3
  - TTLシリアル通信（半二重、1Mbps）
  - 動作電圧: 6〜12V

### I/Oエクスパンダ
- **M5Stack EXTIO2** (I2C接続、アドレス 0x45)
  - リミットスイッチ入力用（6ch）

### ピン配置

| 機能 | M5StampS3ピン |
|------|---------------|
| サーボ Serial TX | GPIO9 |
| サーボ Serial RX | GPIO7 |
| EXTIO2 SDA | GPIO13 |
| EXTIO2 SCL | GPIO15 |
| ボタン1（サーボ1 正回転） | GPIO2 |
| ボタン2（サーボ1 逆回転） | GPIO1 |
| ボタン3（サーボ2 正回転） | GPIO3 |
| ボタン4（サーボ2 逆回転） | GPIO4 |
| ボタン5（サーボ3 正回転） | GPIO5 |
| ボタン6（サーボ3 逆回転） | GPIO6 |

### EXTIO2 リミットスイッチ割り当て

| EXTIO2ピン | 機能 |
|-----------|------|
| 0 | サーボ1 正回転リミット |
| 1 | サーボ1 逆回転リミット |
| 2 | サーボ2 正回転リミット |
| 3 | サーボ2 逆回転リミット |
| 4 | サーボ3 正回転リミット |
| 5 | サーボ3 逆回転リミット |

### 配線

STS3215はデイジーチェーン接続可能。最初のサーボのみM5StampS3に接続し、残りは順番に接続。

```
M5StampS3 TX (GPIO9) ──┐
                        ├── STS3215 (ID:1) ── STS3215 (ID:2) ── STS3215 (ID:3)
M5StampS3 RX (GPIO7) ──┘

M5StampS3 SDA (GPIO13) ── EXTIO2 SDA
M5StampS3 SCL (GPIO15) ── EXTIO2 SCL
```

※ TTL通信のため、TX/RXを1本の信号線に接続する回路（半二重変換）が必要。

## 動作仕様

- ボタンを押している間、対応するサーボが回転（速度: 1500、加速度: 30）
- ボタンを離すと停止
- 各サーボは独立して制御可能
- リミットスイッチがLOWになると該当方向への回転を停止

| ボタン | 動作 |
|--------|------|
| ボタン1 | サーボ1 正回転（CW） |
| ボタン2 | サーボ1 逆回転（CCW） |
| ボタン3 | サーボ2 正回転（CW） |
| ボタン4 | サーボ2 逆回転（CCW） |
| ボタン5 | サーボ3 正回転（CW） |
| ボタン6 | サーボ3 逆回転（CCW） |

## 使用ライブラリ

- [FTServo](https://github.com/ftservo/FTServo_Arduino) - Feetech公式バスサーボライブラリ
- [M5Unit-EXTIO2](https://github.com/m5stack/M5Unit-EXTIO2) - M5Stack EXTIO2 I/Oエクスパンダライブラリ

## ビルド・書き込み

```bash
# ビルド
pio run

# 書き込み
pio run --target upload

# シリアルモニタ
pio device monitor
```
